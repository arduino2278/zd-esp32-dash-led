<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Dashboard LEDs - Commande vocale</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body {
  background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
  color: white;
  min-height: 100vh;
  font-family: Arial, sans-serif;
}

.card {
  background: rgba(255,255,255,0.12);
  border-radius: 22px;
  border: none;
  box-shadow: 0 12px 30px rgba(0,0,0,0.4);
}

.led {
  width: 70px;
  height: 70px;
  border-radius: 50%;
  margin: 15px auto;
  opacity: 0.25;
  transition: all 0.3s ease;
}

.led.on {
  opacity: 1;
  box-shadow: 0 0 30px currentColor;
}

.red    { background: red;    color: red; }
.yellow { background: gold;   color: gold; }
.green  { background: lime;   color: lime; }

.btn-toggle {
  width: 100%;
  font-size: 1.1rem;
  padding: 10px;
}

#voiceSection {
  margin: 30px 0;
}

#log {
  font-size: 18px;
  margin-top: 10px;
}

@media (min-width: 768px) {
  .led {
    width: 85px;
    height: 85px;
  }
}
</style>
</head>

<body>

<div class="container py-4">
  <h2 class="text-center mb-4">üéõÔ∏è Dashboard LEDs - Commande vocale</h2>

  <!-- Section commande vocale -->
  <div id="voiceSection" class="text-center">
    <button class="btn btn-primary btn-lg" onclick="startRecognition()">üé§ Parler</button>
    <p id="log">Commande : ...</p>
  </div>

  <!-- Dashboard boutons -->
  <div class="row g-4">

    <!-- LED ROUGE -->
    <div class="col-12 col-sm-6 col-md-4">
      <div class="card text-center p-4">
        <div id="led0" class="led red"></div>
        <h5>LED Rouge</h5>
        <button class="btn btn-danger btn-toggle" onclick="toggleLed(0,'led0')">OFF</button>
      </div>
    </div>

    <!-- LED JAUNE -->
    <div class="col-12 col-sm-6 col-md-4">
      <div class="card text-center p-4">
        <div id="led1" class="led yellow"></div>
        <h5>LED Jaune</h5>
        <button class="btn btn-warning btn-toggle" onclick="toggleLed(1,'led1')">OFF</button>
      </div>
    </div>

    <!-- LED VERTE -->
    <div class="col-12 col-sm-6 col-md-4">
      <div class="card text-center p-4">
        <div id="led2" class="led green"></div>
        <h5>LED Verte</h5>
        <button class="btn btn-success btn-toggle" onclick="toggleLed(2,'led2')">OFF</button>
      </div>
    </div>

  </div>
</div>

<script>
const BLYNK_TOKEN = "K5zBN_DdyUZgc7Jxhb6ac1yKsLyKAjZc";
let states = [0,0,0]; // 0 = OFF, 1 = ON

// Fonction pour envoyer commande √† Blynk
function sendToBlynk(pin, value) {
  fetch(`https://blynk.cloud/external/api/update?token=${BLYNK_TOKEN}&V${pin}=${value}`);
}

// Fonction pour actualiser le dashboard
function updateDashboard(pin, value) {
  states[pin] = value;
  const ledId = "led" + pin;
  const led = document.getElementById(ledId);
  const btn = led.parentElement.querySelector("button");
  if (value) {
    led.classList.add("on");
    btn.textContent = "ON";
  } else {
    led.classList.remove("on");
    btn.textContent = "OFF";
  }
}

// Toggle LED depuis le dashboard
function toggleLed(pin, ledId) {
  const newState = states[pin] ? 0 : 1;
  sendToBlynk(pin, newState);
  updateDashboard(pin, newState);
}

// Traitement des commandes vocales
function processCommand(text) {
  text = text.toLowerCase();
  if (text.includes("rouge")) {
    const value = text.includes("allumer") ? 1 : (text.includes("√©teindre") ? 0 : states[0]);
    sendToBlynk(0, value);
    updateDashboard(0, value);
  }
  if (text.includes("jaune")) {
    const value = text.includes("allumer") ? 1 : (text.includes("√©teindre") ? 0 : states[1]);
    sendToBlynk(1, value);
    updateDashboard(1, value);
  }
  if (text.includes("verte") || text.includes("vert")) {
    const value = text.includes("allumer") ? 1 : (text.includes("√©teindre") ? 0 : states[2]);
    sendToBlynk(2, value);
    updateDashboard(2, value);
  }
}

// Commande vocale
function startRecognition() {
  const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  recognition.lang = "fr-FR";
  recognition.onresult = function(event) {
    const text = event.results[0][0].transcript;
    document.getElementById("log").innerText = "Commande : " + text;
    processCommand(text);
  };
  recognition.start();
}

// -------- Temps r√©el Blynk --------

// R√©cup√©rer l'√©tat d'une LED depuis Blynk
function fetchBlynkState(pin) {
  fetch(`https://blynk.cloud/external/api/get?token=${BLYNK_TOKEN}&V${pin}`)
    .then(response => response.json())
    .then(data => {
      const value = parseInt(data);
      if (states[pin] !== value) { // si diff√©rent, on met √† jour
        updateDashboard(pin, value);
      }
    })
    .catch(err => console.error("Erreur fetch Blynk:", err));
}

// Mettre √† jour toutes les LEDs en temps r√©el
function startRealtimeUpdate() {
  setInterval(() => {
    for (let pin = 0; pin < states.length; pin++) {
      fetchBlynkState(pin);
    }
  }, 1000); // toutes les 1 seconde
}

// D√©marrage
startRealtimeUpdate();

</script>

</body>
</html>
